# 在庫閾値警告機能 設計書

## 1. 概要

### 目的
品目ごとに在庫の閾値を設定し、在庫数が閾値を下回った場合に画面上で警告を表示する。

### 設計方針
- **画面上の警告表示のみ**（通知機能は実装しない）
- 閾値はデフォルトでは設定なし（ユーザーが明示的に設定するまで警告しない）
- グループ共有アイテムの閾値は全メンバーが変更可能
- 将来的に警告一覧ページを追加予定

### 通知機能を見送る理由
- **プッシュ通知**: Webアプリではバックグラウンド通知の実装が複雑
- **メール通知**: ターゲットユーザー（若者）にはメール通知が馴染みにくい

---

## 2. データベース設計

### 既存テーブルの変更

```prisma
model Item {
  // 既存フィールド...
  id          String   @id @default(cuid())
  name        String
  productName String?
  price       Int?
  quantity    Int      @default(0)
  unit        String
  note        String?
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  userId  String?
  user    User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  groupId String?
  group   Group?  @relation(fields: [groupId], references: [id], onDelete: Cascade)

  // 追加フィールド
  threshold   Int?     // 在庫閾値（nullの場合は警告なし）

  @@map("item")
}
```

### フィールド説明

| フィールド | 型 | 説明 |
|-----------|------|------|
| threshold | Int? | 在庫閾値。nullの場合は警告を表示しない |

---

## 3. 警告ロジック

### 警告条件

```typescript
// 警告を表示する条件
const shouldShowWarning = (item: Item): boolean => {
  // 閾値が設定されていない場合は警告しない
  if (item.threshold === null) return false;

  // 在庫数が閾値以下なら警告
  return item.quantity <= item.threshold;
};
```

### 警告レベル（将来拡張用）

現時点では単一の警告レベルのみ。将来的に以下のような拡張を検討：

| レベル | 条件 | 表示 |
|--------|------|------|
| 警告 | quantity <= threshold | 黄色のアイコン・背景 |
| 危険（将来）| quantity === 0 | 赤色のアイコン・背景 |

---

## 4. UI設計

### 4.1 品目カードの警告表示

```
通常時:
+----------------------------------------+
| ≡ | りんご                    [-] 5個 [+] |
|   | ふじりんご                          |
+----------------------------------------+

閾値以下の警告時（例: threshold=3, quantity=2）:
+----------------------------------------+
| ≡ | ⚠ りんご                  [-] 2個 [+] |
|   | ふじりんご                          |
+----------------------------------------+
※ 黄色/オレンジ色で強調表示
```

### 4.2 品目編集画面への閾値フィールド追加

```
+--------------------------------------------------+
| 品目名 *                                          |
| [りんご                                        ] |
|                                                  |
| 商品名                                            |
| [ふじりんご                                    ] |
|                                                  |
| 数量 *                 単位 *                     |
| [5            ]       [個              ]         |
|                                                  |
| 在庫閾値                                          |
| [3            ]  ← 新規追加                       |
| この数量以下になると警告を表示します                 |
|                                                  |
| メモ                                              |
| [                                              ] |
+--------------------------------------------------+
```

### 4.3 将来: 警告一覧ページ

```
+--------------------------------------------------+
| 在庫警告一覧                                      |
+--------------------------------------------------+
| ⚠ りんご           2個 / 閾値: 3個     [詳細→]   |
| ⚠ 牛乳             1本 / 閾値: 2本     [詳細→]   |
| ⚠ トイレットペーパー  3ロール / 閾値: 5ロール [詳細→] |
+--------------------------------------------------+
```

---

## 5. 機能設計

### 5.1 閾値の設定

- 品目作成時: 任意で閾値を設定可能（デフォルトはnull）
- 品目編集時: 閾値を変更可能
- 閾値を空にすると警告が無効化される

### 5.2 権限

| 操作 | 個人アイテム | グループアイテム |
|------|-------------|-----------------|
| 閾値の設定・変更 | 所有者のみ | 全メンバー |

---

## 6. 実装計画

### Phase 1: 基本実装
1. Prismaスキーマ更新（thresholdフィールド追加）
2. マイグレーション実行
3. バリデーションスキーマ更新
4. 品目作成・編集フォームに閾値フィールド追加
5. 品目カードに警告表示を追加

### Phase 2: 将来拡張（未定）
- 警告一覧ページの追加
- 警告レベルの追加（危険レベル）
- ダッシュボードへの警告サマリー表示

---

## 7. 変更が必要なファイル

### スキーマ・バリデーション
- `prisma/schema.prisma` - thresholdフィールド追加
- `src/lib/validations/item.ts` - threshold追加

### Server Actions
- `src/actions/item.ts` - createItem, updateItemでthreshold対応

### コンポーネント
- `src/components/item/item-form.tsx` - 閾値入力フィールド追加
- `src/components/item/item-card.tsx` - 警告表示ロジック追加
- `src/components/item/sortable-item-card.tsx` - 警告スタイル対応

### 型定義
- `src/generated/prisma/` - Prisma generate後に自動更新
